---
phase: 07-scraper-code-test-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/moxie/scrapers/tier1/rentcafe.py
  - tests/test_scraper_rentcafe.py
  - tests/test_scraper_llm.py
  - tests/test_scraper_appfolio.py
  - src/moxie/scrapers/platform_detect.py
  - tests/test_platform_detect.py
autonomous: true
requirements:
  - SCRAP-01

must_haves:
  truths:
    - "pytest tests/ runs without --ignore flags and all tests pass"
    - "The orphaned tier1/rentcafe.py stub and its test file are removed from the codebase"
    - "sightmap is present in KNOWN_PLATFORMS in platform_detect.py"
  artifacts:
    - path: "src/moxie/scrapers/platform_detect.py"
      provides: "KNOWN_PLATFORMS with sightmap included"
      contains: '"sightmap"'
    - path: "tests/test_scraper_llm.py"
      provides: "Fixed FakeResult mock with success, status_code, markdown attributes"
      contains: "result.success = True"
    - path: "tests/test_scraper_appfolio.py"
      provides: "Updated test fixtures using real AppFolio HTML selectors"
      contains: "_parse_listings_html"
  key_links:
    - from: "tests/test_scraper_appfolio.py"
      to: "src/moxie/scrapers/tier2/appfolio.py"
      via: "import _parse_listings_html"
      pattern: "from moxie\\.scrapers\\.tier2\\.appfolio import _parse_listings_html"
    - from: "tests/test_scraper_llm.py"
      to: "src/moxie/scrapers/tier3/llm.py"
      via: "FakeResult mock attributes match production CrawlResult"
      pattern: "result\\.success = True"
---

<objective>
Remove orphaned RentCafe tier1 stub, fix all broken tests, and add sightmap to KNOWN_PLATFORMS so `pytest tests/` runs clean with zero failures and no --ignore flags.

Purpose: Close SCRAP-01 formally by deleting the dead tier1 RentCafe stub (SecureCafe is the sole implementation), fix 8 broken test items (1 collection error + 7 failures), and correct the KNOWN_PLATFORMS gap.

Output: All test files passing, dead code removed, platform detection complete.
</objective>

<execution_context>
@C:/Users/eimil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/eimil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-scraper-code-test-cleanup/07-RESEARCH.md
@src/moxie/scrapers/tier2/appfolio.py
@src/moxie/scrapers/tier3/llm.py
@src/moxie/scrapers/platform_detect.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete orphaned RentCafe stub, add sightmap to KNOWN_PLATFORMS, add KNOWN_PLATFORMS test</name>
  <files>
    src/moxie/scrapers/tier1/rentcafe.py
    tests/test_scraper_rentcafe.py
    src/moxie/scrapers/platform_detect.py
    tests/test_platform_detect.py
  </files>
  <action>
1. **Delete** `src/moxie/scrapers/tier1/rentcafe.py` — this is dead code. The `registry.py` maps `"rentcafe"` to `moxie.scrapers.tier2.securecafe`, not tier1. No production code imports this file (verified by grep in research). The `tier1/` directory keeps `__init__.py` and `ppm.py`.

2. **Delete** `tests/test_scraper_rentcafe.py` — tests for the dead tier1 stub. All 14 tests pass but test code that is never used. Delete in the same operation as the source file (Pitfall 4 from research: never partially remove).

3. **Add `"sightmap"` to KNOWN_PLATFORMS** in `src/moxie/scrapers/platform_detect.py`. Current frozenset:
   ```python
   KNOWN_PLATFORMS: frozenset[str] = frozenset({
       "rentcafe", "ppm", "entrata", "mri", "funnel", "realpage", "bozzuto", "groupfox", "appfolio", "llm"
   })
   ```
   Add `"sightmap"` before `"llm"` (alphabetical within the group):
   ```python
   KNOWN_PLATFORMS: frozenset[str] = frozenset({
       "rentcafe", "ppm", "entrata", "mri", "funnel", "realpage", "bozzuto", "groupfox", "appfolio",
       "sightmap", "llm"
   })
   ```

4. **Add a simple test** in `tests/test_platform_detect.py` asserting `"sightmap" in KNOWN_PLATFORMS`. Import `KNOWN_PLATFORMS` from `moxie.scrapers.platform_detect` and add:
   ```python
   def test_known_platforms_contains_sightmap():
       """sightmap must be in KNOWN_PLATFORMS (58 buildings classified as sightmap)."""
       from moxie.scrapers.platform_detect import KNOWN_PLATFORMS
       assert "sightmap" in KNOWN_PLATFORMS
   ```
   Place this after the existing parametrized detect_platform tests.
  </action>
  <verify>
Run:
```bash
pytest tests/test_platform_detect.py -v
```
Confirm all existing tests plus the new sightmap test pass.

Confirm deleted files no longer exist:
```bash
python -c "import pathlib; assert not pathlib.Path('src/moxie/scrapers/tier1/rentcafe.py').exists(); assert not pathlib.Path('tests/test_scraper_rentcafe.py').exists(); print('OK')"
```
  </verify>
  <done>
- tier1/rentcafe.py and test_scraper_rentcafe.py are deleted
- "sightmap" appears in KNOWN_PLATFORMS frozenset
- test_known_platforms_contains_sightmap passes
- No import errors or collection errors from the deletions
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix broken LLM and AppFolio test files</name>
  <files>
    tests/test_scraper_llm.py
    tests/test_scraper_appfolio.py
  </files>
  <action>
### Fix 1: test_scraper_llm.py — Add missing FakeResult attributes

In the `_make_fake_crawler_ctx()` function (around line 60-66), the `FakeResult` object is missing three attributes that `_probe_subpage()` in `llm.py` now checks. Add these three lines after the existing attribute assignments:

```python
result.extracted_content = extracted_content
result.links = {}   # Pass 1: no internal links -> fall back to original URL
result.html = ""    # Pass 1 also checks .html in some paths
result.success = True          # _probe_subpage checks this
result.status_code = 200       # _probe_subpage checks this after .success
result.markdown = ""           # _probe_subpage checks this for content keywords
```

**Why these values work:** With `.success = True` and `.status_code = 200`, `_probe_subpage` proceeds past the guard. With `.markdown = ""`, the content keyword check (`any(kw in content_lower for kw in _CONTENT_KEYWORDS)`) returns False for all explicit subpages, so Pass 1 falls through to link scoring. Since `.links = {}`, link scoring finds nothing, and `_find_availability_link` returns None. Then `target_url = url` (original URL) and Pass 2 proceeds with `extracted_content` — which is what the tests intend to test.

### Fix 2: test_scraper_appfolio.py — Update imports and fixtures

**Step A — Fix the import line (line 8):**
Change:
```python
from moxie.scrapers.tier2.appfolio import _parse_html, _fetch_html, AppFolioScraperError
```
To:
```python
from moxie.scrapers.tier2.appfolio import _parse_listings_html, _fetch_html, AppFolioScraperError
```

**Step B — Replace ALL HTML fixtures** to use real AppFolio selectors (verified against sedgwickproperties.appfolio.com). The current fixtures use imagined selectors (`.listing-item`, `.bedroom-count`, `.price`, `.available-date`, `.unit-number`) that don't match the actual implementation.

Replace `SAMPLE_HTML`:
```python
SAMPLE_HTML = """
<div class="js-listing-item">
  <img alt="123 Main St , Unit 3B, Chicago, IL 60610" />
  <div class="detail-box__value">$2,500</div>
  <div class="detail-box__value">2 bd / 1 ba</div>
  <div class="js-listing-available">April 1, 2026</div>
</div>
"""
```

Replace `MULTI_UNIT_HTML`:
```python
MULTI_UNIT_HTML = """
<div class="js-listing-item">
  <img alt="123 Main St , Unit 1A, Chicago, IL 60610" />
  <div class="detail-box__value">$1,300</div>
  <div class="detail-box__value">0 bd / 1 ba</div>
  <div class="js-listing-available">Now</div>
</div>
<div class="js-listing-item">
  <img alt="123 Main St , Unit 2C, Chicago, IL 60610" />
  <div class="detail-box__value">$1,800</div>
  <div class="detail-box__value">1 bd / 1 ba</div>
  <div class="js-listing-available">March 15, 2026</div>
</div>
"""
```

Replace `INCOMPLETE_HTML` (a card with no `img[alt]` containing "Unit" — `_parse_listings_html` skips cards where unit_number is None):
```python
INCOMPLETE_HTML = """
<div class="js-listing-item">
  <img alt="123 Main St , Chicago, IL 60610" />
  <div class="detail-box__value">$2,500</div>
  <div class="detail-box__value">2 bd / 1 ba</div>
</div>
"""
```

Keep `NO_UNITS_HTML` as-is (no `.js-listing-item` containers = empty result — works with new parser too).

**Step C — Update all `TestParseHtml` test methods:**

1. All calls to `_parse_html(...)` become `_parse_listings_html(...)`.

2. Update assertions to match new fixture values:
   - `test_parse_html_extracts_units`: `_parse_listings_html(SAMPLE_HTML)` returns 1 unit.
   - `test_parse_html_unit_fields`: Unit fields are now `unit_number="3B"`, `bed_type="2 bd / 1 ba"`, `rent="$2,500"`, `availability_date="April 1, 2026"`.
   - `test_parse_html_multiple_units`: `_parse_listings_html(MULTI_UNIT_HTML)` returns 2 units.
   - `test_parse_html_returns_list_of_dicts`: Same key assertions (unit_number, bed_type, rent, availability_date) — these are unchanged.
   - `test_parse_html_incomplete_rows_skipped`: `_parse_listings_html(INCOMPLETE_HTML)` returns `[]` because the card has no "Unit NNN" in img[alt].
   - `test_parse_html_missing_unit_number_defaults_to_na`: This test's premise no longer applies — `_parse_listings_html` **skips** cards without a unit number (it does `if not unit_number: continue`), it does not default to "N/A". **Rewrite this test** to verify that cards without "Unit NNN" in the alt text are skipped:
     ```python
     def test_parse_html_missing_unit_number_skipped(self):
         """Cards without 'Unit NNN' in img alt are skipped entirely."""
         html = """
         <div class="js-listing-item">
           <img alt="123 Main St , Chicago, IL 60610" />
           <div class="detail-box__value">$1,200</div>
           <div class="detail-box__value">0 bd / 1 ba</div>
           <div class="js-listing-available">Now</div>
         </div>
         """
         result = _parse_listings_html(html)
         assert result == []
     ```
   - `test_parse_html_missing_availability_defaults_to_available_now`: Update the fixture to use real selectors and update the call to `_parse_listings_html`:
     ```python
     def test_parse_html_missing_availability_defaults_to_available_now(self):
         """Cards without .js-listing-available default to 'Available Now'."""
         html = """
         <div class="js-listing-item">
           <img alt="123 Main St , Unit 4D, Chicago, IL 60610" />
           <div class="detail-box__value">$1,600</div>
           <div class="detail-box__value">1 bd / 1 ba</div>
         </div>
         """
         result = _parse_listings_html(html)
         assert len(result) == 1
         assert result[0]["availability_date"] == "Available Now"
     ```

**Step D — `TestFetchHtml` class:** Only the import needs fixing (already done in Step A). All `_fetch_html` tests use `httpx_mock` and test HTTP error handling — the function signature is unchanged. No fixture or assertion changes needed.
  </action>
  <verify>
Run the full test suite without any ignore flags:
```bash
pytest tests/ -v
```
Confirm:
- 0 collection errors
- 0 test failures
- All tests in test_scraper_llm.py pass (including the 7 that were previously failing)
- All tests in test_scraper_appfolio.py pass (including the ones that were previously erroring at collection)
- Total test count is previous total minus 14 (deleted rentcafe tests)
  </verify>
  <done>
- FakeResult in test_scraper_llm.py has .success, .status_code, and .markdown attributes
- All 7 previously-failing LLM tests pass
- test_scraper_appfolio.py imports _parse_listings_html (not _parse_html)
- All AppFolio test fixtures use real selectors (.js-listing-item, .detail-box__value, .js-listing-available, img[alt])
- `pytest tests/` runs clean: 0 errors, 0 failures, no --ignore flags needed
  </done>
</task>

</tasks>

<verification>
Run the complete test suite from the project root:

```bash
export PATH="/c/Users/eimil/.local/bin:$PATH" && export PYTHONIOENCODING=utf-8
uv run pytest tests/ -v --tb=short
```

Expected outcome:
- 0 collection errors
- 0 test failures
- All tests pass
- No --ignore flags needed
- tier1/rentcafe.py and test_scraper_rentcafe.py do not exist
- "sightmap" in KNOWN_PLATFORMS confirmed by test
</verification>

<success_criteria>
1. `pytest tests/` runs without `--ignore` flags and all tests pass (0 errors, 0 failures)
2. `src/moxie/scrapers/tier1/rentcafe.py` does not exist
3. `tests/test_scraper_rentcafe.py` does not exist
4. `"sightmap"` is in `KNOWN_PLATFORMS` in `platform_detect.py`
5. Total test count = previous total minus 14 (removed rentcafe tests) plus 1 (new sightmap test)
</success_criteria>

<output>
After completion, create `.planning/phases/07-scraper-code-test-cleanup/07-01-SUMMARY.md`
</output>
