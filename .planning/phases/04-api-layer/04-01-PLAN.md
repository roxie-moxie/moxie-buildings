---
phase: 04-api-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/moxie/db/models.py
  - alembic/versions/add_users_table.py
  - src/moxie/api/__init__.py
  - src/moxie/api/settings.py
  - src/moxie/api/auth.py
  - src/moxie/api/deps.py
  - src/moxie/api/main.py
  - scripts/create_admin.py
autonomous: true
requirements:
  - AGENT-01
  - ADMIN-01
  - ADMIN-02

must_haves:
  truths:
    - "A User row with role='admin' can be created via the create-admin CLI command"
    - "Passwords are hashed with Argon2 and never stored in plaintext"
    - "A JWT can be created from a user ID and decoded back to that same user ID"
    - "An expired JWT is rejected on decode"
    - "The FastAPI app starts with CORS configured from CORS_ORIGINS env var"
    - "get_current_user dependency rejects requests with invalid/expired tokens"
    - "get_current_user dependency rejects requests for inactive users (is_active=False)"
    - "require_admin dependency rejects non-admin users with 403"
  artifacts:
    - path: "src/moxie/db/models.py"
      provides: "User model with id, name, email, password_hash, role, is_active, created_at"
      contains: "class User"
    - path: "src/moxie/api/settings.py"
      provides: "Settings class with secret_key, database_url, cors_origins"
      contains: "class Settings"
    - path: "src/moxie/api/auth.py"
      provides: "JWT and password hashing helpers"
      exports: ["create_access_token", "decode_token", "hash_password", "verify_password"]
    - path: "src/moxie/api/deps.py"
      provides: "FastAPI dependency chain for auth"
      exports: ["get_current_user", "require_admin"]
    - path: "src/moxie/api/main.py"
      provides: "FastAPI app factory with CORS middleware"
      contains: "CORSMiddleware"
    - path: "scripts/create_admin.py"
      provides: "CLI to bootstrap first admin user"
  key_links:
    - from: "src/moxie/api/deps.py"
      to: "src/moxie/api/auth.py"
      via: "decode_token call in get_current_user"
      pattern: "decode_token"
    - from: "src/moxie/api/deps.py"
      to: "src/moxie/db/models.py"
      via: "User lookup by ID from decoded JWT"
      pattern: "db\\.get\\(User"
    - from: "src/moxie/api/auth.py"
      to: "src/moxie/api/settings.py"
      via: "SECRET_KEY for JWT signing"
      pattern: "settings\\.secret_key"
    - from: "scripts/create_admin.py"
      to: "src/moxie/api/auth.py"
      via: "hash_password for admin password"
      pattern: "hash_password"
---

<objective>
Set up the FastAPI application scaffold, User model with Alembic migration, JWT auth helpers, dependency injection chain, pydantic-settings configuration, and create-admin CLI command.

Purpose: This is the foundation that all API endpoints depend on -- the User table must exist before login works, the auth helpers must exist before protected routes can be wired, and the app factory must exist before any router can be mounted.

Output: A runnable FastAPI app (no endpoints yet), a User table in the database, and a CLI to bootstrap the first admin account.
</objective>

<execution_context>
@C:/Users/eimil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/eimil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-api-layer/04-CONTEXT.md
@.planning/phases/04-api-layer/04-RESEARCH.md
@src/moxie/db/models.py
@src/moxie/db/session.py
@src/moxie/config.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FastAPI dependencies, User model, and Alembic migration</name>
  <files>
    pyproject.toml
    src/moxie/db/models.py
    alembic/versions/add_users_table.py
  </files>
  <action>
1. Add dependencies to pyproject.toml `dependencies` list:
   - `fastapi>=0.115.0`
   - `uvicorn>=0.34.0`
   - `PyJWT>=2.0`
   - `"pwdlib[argon2]"`
   - `pydantic-settings>=2.0`
   - `python-multipart>=0.0.20`

2. Run `uv sync` to install all new dependencies.

3. Add User model to `src/moxie/db/models.py` (after the ScrapeRun class):
   ```python
   class User(Base):
       __tablename__ = "users"
       id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True)
       name: Mapped[str] = mapped_column(String, nullable=False)
       email: Mapped[str] = mapped_column(String, unique=True, nullable=False)
       password_hash: Mapped[str] = mapped_column(String, nullable=False)
       role: Mapped[str] = mapped_column(String, nullable=False, server_default="agent")
       is_active: Mapped[bool] = mapped_column(Boolean, nullable=False, server_default="1")
       created_at: Mapped[datetime] = mapped_column(nullable=False, default=lambda: datetime.now(timezone.utc))
   ```
   Note: Use `datetime.now(timezone.utc)` not deprecated `datetime.utcnow()`. Import `timezone` from `datetime` module (already imported at top of file). The `role` field uses server_default="agent" so new users default to agent role. The `is_active` field uses server_default="1" (SQLite boolean).

4. Generate Alembic migration:
   ```bash
   export PATH="/c/Users/eimil/.local/bin:$PATH"
   cd "C:/Users/eimil/projects/Roxie Projects/moxie-buildings"
   uv run alembic revision --autogenerate -m "add users table"
   ```

5. Run the migration:
   ```bash
   uv run alembic upgrade head
   ```
  </action>
  <verify>
Run: `export PATH="/c/Users/eimil/.local/bin:$PATH" && cd "C:/Users/eimil/projects/Roxie Projects/moxie-buildings" && uv run python -c "from moxie.db.models import User; print(User.__tablename__)"` -- should print "users".

Run: `uv run alembic heads` -- should show a single head with "add users table" message.

Run: `uv run python -c "from moxie.db.session import SessionLocal; db=SessionLocal(); db.execute(__import__('sqlalchemy').text('SELECT name FROM sqlite_master WHERE type=\"table\" AND name=\"users\"')); print('users table exists'); db.close()"` -- should print "users table exists".

Run existing test suite: `uv run pytest tests/ -x -q` -- all existing tests pass (no regressions).
  </verify>
  <done>User model exists in models.py, migration generated and applied, users table exists in moxie.db, all 6 new pip packages installed, existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: API scaffold -- settings, auth helpers, dependency chain, app factory, create-admin CLI</name>
  <files>
    src/moxie/api/__init__.py
    src/moxie/api/settings.py
    src/moxie/api/auth.py
    src/moxie/api/deps.py
    src/moxie/api/main.py
    scripts/create_admin.py
    pyproject.toml
  </files>
  <action>
1. Create `src/moxie/api/__init__.py` (empty).

2. Create `src/moxie/api/settings.py`:
   - Use `pydantic_settings.BaseSettings` with `SettingsConfigDict(env_file=".env", extra="ignore")`
   - Fields: `secret_key: str = "change-me-in-production"`, `database_url: str = "sqlite:///./moxie.db"`, `cors_origins: str = "http://localhost:3000,http://localhost:5173"`
   - Add `@lru_cache` wrapped `get_settings()` function
   - Reference: Pattern 7 from 04-RESEARCH.md

3. Create `src/moxie/api/auth.py`:
   - Import `jwt` (PyJWT), `pwdlib.PasswordHash`
   - `password_hasher = PasswordHash.recommended()` -- uses Argon2 by default
   - `ALGORITHM = "HS256"`
   - `ACCESS_TOKEN_EXPIRE_HOURS = 8` -- per user decision (one login per shift)
   - `hash_password(plain: str) -> str` -- calls `password_hasher.hash(plain)`
   - `verify_password(plain: str, hashed: str) -> bool` -- calls `password_hasher.verify(plain, hashed)`
   - `create_access_token(user_id: int) -> str` -- encode `{"sub": str(user_id), "exp": utc_now + 8h}` with SECRET_KEY from `get_settings()`
   - `decode_token(token: str) -> int` -- decode, extract "sub", return int(sub). Raises `jwt.exceptions.InvalidTokenError` on failure.
   - Reference: Pattern 1 from 04-RESEARCH.md. Use `datetime.now(timezone.utc)` not deprecated `utcnow()`.

4. Create `src/moxie/api/deps.py`:
   - Import `HTTPBearer`, `HTTPAuthorizationCredentials` from `fastapi.security`
   - Import `get_db` from `moxie.db.session`
   - `bearer = HTTPBearer()`
   - `get_current_user(credentials, db)` dependency:
     - Extract token from credentials.credentials
     - Call decode_token -- on any exception raise HTTPException 401 with detail "Invalid or expired token" and WWW-Authenticate: Bearer header
     - Look up user: `db.get(User, user_id)`
     - If user is None or not user.is_active: raise HTTPException 401 with detail "Account inactive or not found"
     - Return user
   - `require_admin(current_user)` dependency:
     - If current_user.role != "admin": raise HTTPException 403 with detail "Admin access required"
     - Return current_user
   - Reference: Pattern 2 from 04-RESEARCH.md

5. Create `src/moxie/api/main.py`:
   - `create_app()` factory function that returns a FastAPI instance
   - Parse CORS_ORIGINS from settings (split by comma, strip whitespace)
   - Add CORSMiddleware with `allow_credentials=True`, `allow_methods=["*"]`, `allow_headers=["*"]`, explicit origins list
   - Do NOT include any routers yet -- Plan 02 handles endpoint registration
   - Add a `GET /health` route returning `{"status": "ok"}` for smoke testing
   - `app = create_app()` at module level for uvicorn
   - Reference: Pattern 5 from 04-RESEARCH.md

6. Create `scripts/create_admin.py`:
   - `main()` function using argparse with `--email`, `--password`, `--name` (all required)
   - Import `SessionLocal` from `moxie.db.session`, `User` from `moxie.db.models`, `hash_password` from `moxie.api.auth`
   - Create User with role="admin", is_active=True, hashed password
   - Handle duplicate email gracefully (catch IntegrityError, print message)
   - Print success confirmation
   - Reference: CLI Seed Command from 04-RESEARCH.md

7. Register CLI in `pyproject.toml` under `[project.scripts]`:
   - `create-admin = "scripts.create_admin:main"`

8. Run `uv sync` to register the new script entry point.
  </action>
  <verify>
Run: `export PATH="/c/Users/eimil/.local/bin:$PATH" && cd "C:/Users/eimil/projects/Roxie Projects/moxie-buildings"`

Test settings load:
`uv run python -c "from moxie.api.settings import get_settings; s = get_settings(); print(f'secret_key={s.secret_key}, cors={s.cors_origins}')"` -- should print defaults.

Test auth helpers:
`uv run python -c "from moxie.api.auth import hash_password, verify_password, create_access_token, decode_token; h = hash_password('test123'); assert verify_password('test123', h); assert not verify_password('wrong', h); t = create_access_token(42); assert decode_token(t) == 42; print('auth helpers OK')"` -- should print "auth helpers OK".

Test app starts:
`uv run python -c "from moxie.api.main import app; from fastapi.testclient import TestClient; c = TestClient(app); r = c.get('/health'); assert r.status_code == 200; print(r.json())"` -- should print `{'status': 'ok'}`.

Test create-admin CLI:
`uv run create-admin --email admin@test.com --password testpass123 --name "Test Admin"` -- should print success message.

Verify admin in DB:
`uv run python -c "from moxie.db.session import SessionLocal; from moxie.db.models import User; db=SessionLocal(); u=db.query(User).filter(User.email=='admin@test.com').first(); print(f'role={u.role}, active={u.is_active}'); db.close()"` -- should print "role=admin, active=True".

Run existing tests: `uv run pytest tests/ -x -q` -- all pass.
  </verify>
  <done>
API scaffold is complete: settings load from env/.env, auth helpers hash+verify passwords and create+decode JWTs, dependency chain enforces auth and admin role, FastAPI app starts with CORS and /health endpoint, create-admin CLI creates an admin user in the DB. All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from moxie.db.models import User; print('User model OK')"` -- imports without error
2. `uv run alembic current` -- shows latest migration applied
3. `uv run python -c "from moxie.api.main import app; print(type(app))"` -- prints FastAPI class
4. `uv run create-admin --email verify@test.com --password pass123 --name Verify` -- creates admin
5. `uv run pytest tests/ -x -q` -- all existing tests pass
</verification>

<success_criteria>
- User model exists in models.py with all required fields (name, email, password_hash, role, is_active, created_at)
- Alembic migration generated and applied -- users table exists in moxie.db
- FastAPI app starts and responds to GET /health
- CORS middleware configured with origins from CORS_ORIGINS env var
- Auth helpers correctly hash/verify passwords and create/decode JWTs with 8-hour expiry
- get_current_user dependency rejects invalid tokens and inactive users
- require_admin dependency rejects non-admin users
- create-admin CLI creates admin user with hashed password
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/04-api-layer/04-01-SUMMARY.md`
</output>
