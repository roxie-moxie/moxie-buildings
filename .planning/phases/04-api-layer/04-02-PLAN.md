---
phase: 04-api-layer
plan: 02
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - src/moxie/api/schemas/__init__.py
  - src/moxie/api/schemas/auth.py
  - src/moxie/api/schemas/admin.py
  - src/moxie/api/schemas/units.py
  - src/moxie/api/routers/__init__.py
  - src/moxie/api/routers/auth.py
  - src/moxie/api/routers/admin.py
  - src/moxie/api/routers/units.py
  - src/moxie/api/main.py
autonomous: true
requirements:
  - AGENT-01
  - ADMIN-01
  - ADMIN-02
  - ADMIN-03
  - ADMIN-04

must_haves:
  truths:
    - "An agent can POST /auth/login with email+password and receive a JWT access token"
    - "Invalid credentials return 401, not 500"
    - "An inactive account cannot log in (returns 401)"
    - "An admin can POST /admin/users to create a new agent account"
    - "An admin can PATCH /admin/users/{id}/deactivate to disable an agent"
    - "A deactivated agent's existing JWT is rejected on the next request"
    - "An admin can GET /admin/buildings to see all buildings with platform and last_scraped_at"
    - "An admin can POST /admin/rescrape/{building_id} and receive a job_id"
    - "Attempting a second re-scrape on the same building returns 409"
    - "An admin can GET /admin/rescrape/{job_id} to poll for scrape completion"
    - "An agent can GET /units with filter params and receive matching units with last_scraped timestamps"
    - "Non-admin users receive 403 on all /admin/* endpoints"
    - "Unauthenticated requests to protected endpoints return 401"
  artifacts:
    - path: "src/moxie/api/routers/auth.py"
      provides: "POST /auth/login endpoint"
      contains: "router.post"
    - path: "src/moxie/api/routers/admin.py"
      provides: "Admin CRUD + buildings + re-scrape endpoints"
      contains: "router = APIRouter"
    - path: "src/moxie/api/routers/units.py"
      provides: "GET /units search endpoint with filters"
      contains: "router.get"
    - path: "src/moxie/api/schemas/auth.py"
      provides: "LoginRequest and TokenResponse models"
      contains: "class LoginRequest"
    - path: "src/moxie/api/schemas/admin.py"
      provides: "UserCreate, UserOut, BuildingOut, RescrapeJobOut models"
      contains: "class UserCreate"
    - path: "src/moxie/api/schemas/units.py"
      provides: "UnitOut and UnitsResponse models"
      contains: "class UnitOut"
  key_links:
    - from: "src/moxie/api/routers/auth.py"
      to: "src/moxie/api/auth.py"
      via: "verify_password + create_access_token on login"
      pattern: "verify_password.*create_access_token"
    - from: "src/moxie/api/routers/admin.py"
      to: "src/moxie/api/deps.py"
      via: "Router-level dependencies=[Depends(require_admin)]"
      pattern: "dependencies=.*require_admin"
    - from: "src/moxie/api/routers/admin.py"
      to: "src/moxie/scheduler/runner.py"
      via: "asyncio.to_thread(scrape_one_building, ...) for re-scrape"
      pattern: "asyncio\\.to_thread.*scrape_one_building"
    - from: "src/moxie/api/routers/units.py"
      to: "src/moxie/db/models.py"
      via: "Unit.join(Building) query for last_scraped_at"
      pattern: "join\\(Building\\)"
    - from: "src/moxie/api/main.py"
      to: "src/moxie/api/routers/"
      via: "app.include_router for all 3 routers"
      pattern: "include_router"
---

<objective>
Build all API endpoint routers (auth login, admin management, unit search), their Pydantic request/response schemas, and wire everything into the FastAPI app.

Purpose: This plan delivers the full HTTP API contract that Phase 5's frontend will consume. After this plan, every requirement (AGENT-01, ADMIN-01 through ADMIN-04) has a working endpoint.

Output: Three routers (auth, admin, units) with schemas, mounted in the FastAPI app. All endpoints functional against the real database.
</objective>

<execution_context>
@C:/Users/eimil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/eimil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-api-layer/04-CONTEXT.md
@.planning/phases/04-api-layer/04-RESEARCH.md
@.planning/phases/04-api-layer/04-01-SUMMARY.md
@src/moxie/db/models.py
@src/moxie/db/session.py
@src/moxie/scheduler/runner.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auth login router + Admin router (user CRUD, buildings, re-scrape) + schemas</name>
  <files>
    src/moxie/api/schemas/__init__.py
    src/moxie/api/schemas/auth.py
    src/moxie/api/schemas/admin.py
    src/moxie/api/routers/__init__.py
    src/moxie/api/routers/auth.py
    src/moxie/api/routers/admin.py
  </files>
  <action>
1. Create `src/moxie/api/schemas/__init__.py` (empty).
2. Create `src/moxie/api/routers/__init__.py` (empty).

3. Create `src/moxie/api/schemas/auth.py`:
   - `LoginRequest(BaseModel)`: email (str), password (str)
   - `TokenResponse(BaseModel)`: access_token (str), token_type (str, default="bearer")

4. Create `src/moxie/api/schemas/admin.py`:
   - `UserCreate(BaseModel)`: name (str), email (EmailStr or str), password (str, min_length=8 -- reasonable default for internal tool per Claude's discretion)
   - `UserOut(BaseModel)`: id (int), name (str), email (str), role (str), is_active (bool), created_at (datetime). Use `model_config = ConfigDict(from_attributes=True)`.
   - `BuildingOut(BaseModel)`: id (int), name (str), url (str), neighborhood (str | None), management_company (str | None), platform (str | None), last_scraped_at (datetime | None), last_scrape_status (str). Use `model_config = ConfigDict(from_attributes=True)`.
   - `RescrapeJobOut(BaseModel)`: job_id (str), status (str), building_id (int), unit_count (int | None = None), error (str | None = None), duration_seconds (float | None = None)

5. Create `src/moxie/api/routers/auth.py`:
   - Router with `prefix="/auth"`, `tags=["auth"]`
   - `POST /auth/login` accepting `LoginRequest` body:
     - Query User by email
     - If user not found or password wrong: raise 401 "Invalid email or password" with WWW-Authenticate header
     - If user.is_active is False: raise 401 "Account is inactive"
     - Create access token and return TokenResponse
   - Reference: Login Endpoint from 04-RESEARCH.md. Use JSON body (not OAuth2PasswordRequestForm) per user decision.

6. Create `src/moxie/api/routers/admin.py`:
   - Router with `prefix="/admin"`, `tags=["admin"]`, `dependencies=[Depends(require_admin)]` -- router-level admin protection per Pattern 3
   - Module-level dicts for re-scrape job tracking:
     - `_jobs: dict[str, dict] = {}` (job_id -> status dict)
     - `_building_jobs: dict[int, str] = {}` (building_id -> active job_id)

   **Endpoint: POST /admin/users** (ADMIN-01)
   - Accept UserCreate body
   - Hash password with hash_password()
   - Create User with role="agent", is_active=True
   - Handle duplicate email: catch IntegrityError, return 409 "Email already registered"
   - Return UserOut (201 status)

   **Endpoint: PATCH /admin/users/{user_id}/deactivate** (ADMIN-02)
   - Look up user by ID; 404 if not found
   - Set is_active=False, commit
   - Return UserOut

   **Endpoint: GET /admin/users** (supporting ADMIN-01/02 -- list users for admin reference)
   - Return list of UserOut for all users

   **Endpoint: GET /admin/buildings** (ADMIN-03)
   - Query all buildings ordered by name
   - Return list of BuildingOut

   **Endpoint: POST /admin/rescrape/{building_id}** (ADMIN-04 -- trigger)
   - Check if building_id already has an active job in _building_jobs: if so, raise 409 "Scrape already in progress for this building"
   - Look up building by ID; 404 if not found
   - Generate UUID job_id, store in _jobs and _building_jobs
   - Create async background task: `asyncio.create_task(_run_scrape_job(...))`
   - The `_run_scrape_job` coroutine must use `asyncio.to_thread(scrape_one_building, ...)` because scrape_one_building is synchronous and blocking (uses time.sleep, creates its own SessionLocal). Do NOT call it directly as a coroutine.
   - Return RescrapeJobOut with status="queued" (202 status)
   - Reference: Pattern 4 from 04-RESEARCH.md

   **Endpoint: GET /admin/rescrape/{job_id}** (ADMIN-04 -- poll)
   - Look up job_id in _jobs; 404 if not found
   - Return RescrapeJobOut with current status

   **Helper: async _run_scrape_job(job_id, building_id, building_name, building_url, platform)**
   - Set status to "running"
   - Record start time
   - Call `await asyncio.to_thread(scrape_one_building, building_id, building_name, building_url, platform)`
   - On completion: update _jobs with status (from result["status"]), unit_count, error, duration_seconds
   - In finally block: remove building_id from _building_jobs
  </action>
  <verify>
Run: `export PATH="/c/Users/eimil/.local/bin:$PATH" && cd "C:/Users/eimil/projects/Roxie Projects/moxie-buildings"`

Test schemas import:
`uv run python -c "from moxie.api.schemas.auth import LoginRequest, TokenResponse; from moxie.api.schemas.admin import UserCreate, UserOut, BuildingOut, RescrapeJobOut; print('schemas OK')"`

Test router import:
`uv run python -c "from moxie.api.routers.auth import router as auth_router; from moxie.api.routers.admin import router as admin_router; print('routers OK')"`

Test login flow (using TestClient):
```python
uv run python -c "
from fastapi.testclient import TestClient
from moxie.api.main import app
c = TestClient(app)
# Login should fail with invalid credentials
r = c.post('/auth/login', json={'email': 'nobody@test.com', 'password': 'wrong'})
assert r.status_code == 401, f'Expected 401 got {r.status_code}'
print('login 401 on invalid credentials: OK')
"
```

Run existing tests: `uv run pytest tests/ -x -q` -- all pass.
  </verify>
  <done>
Auth login endpoint accepts JSON credentials and returns JWT. Admin router protects all /admin/* endpoints with require_admin. Admin can create agent users, deactivate users, list all users, view buildings, trigger re-scrape with polling. All schemas validate input/output shapes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit search router + schemas + wire all routers into app</name>
  <files>
    src/moxie/api/schemas/units.py
    src/moxie/api/routers/units.py
    src/moxie/api/main.py
  </files>
  <action>
1. Create `src/moxie/api/schemas/units.py`:
   - `UnitOut(BaseModel)`:
     - id (int), building_id (int), building_name (str), building_url (str)
     - unit_number (str), bed_type (str), rent_cents (int), availability_date (str)
     - floor_plan_name (str | None), baths (str | None), sqft (int | None)
     - neighborhood (str | None), last_scraped (datetime | None)
     - Use `model_config = ConfigDict(from_attributes=True)` -- but note: last_scraped and building_name are joined fields, not direct ORM attributes. The serialization must be done manually in a helper function.
   - `UnitsResponse(BaseModel)`:
     - units (list[UnitOut]), total (int)
     - Per research recommendation: wrapped object for extensibility

2. Create `src/moxie/api/routers/units.py`:
   - Router with `prefix=""`, `tags=["units"]` (no prefix -- mounted at root level)
   - Import `get_current_user` from deps (not `require_admin` -- agents access this)

   **Endpoint: GET /units** (AGENT-01 search)
   - All filter params are optional Query parameters:
     - `beds: list[str] | None = Query(default=None)` -- multi-select bed types (e.g., ?beds=1BR&beds=2BR)
     - `rent_min: int | None = Query(default=None, ge=0)` -- minimum rent in dollars
     - `rent_max: int | None = Query(default=None, ge=0)` -- maximum rent in dollars
     - `available_before: str | None = Query(default=None)` -- "YYYY-MM-DD" date string
     - `neighborhood: list[str] | None = Query(default=None)` -- multi-select neighborhoods
   - Require authentication via `Depends(get_current_user)` (use `_: User = Depends(get_current_user)` to enforce auth without using the user object)
   - Build SQLAlchemy query:
     - `db.query(Unit).join(Building)` -- join for building fields
     - Filter `Unit.non_canonical == False` by default (Phase 1 decision: API hides non-canonical units)
     - If beds provided: `Unit.bed_type.in_(beds)`
     - If rent_min: `Unit.rent_cents >= rent_min * 100` (input is dollars, DB stores cents)
     - If rent_max: `Unit.rent_cents <= rent_max * 100`
     - If available_before: `Unit.availability_date <= available_before` (string comparison works for YYYY-MM-DD format; also handle "Available Now" by including units where availability_date == "Available Now" regardless of the filter)
     - If neighborhood: `Building.neighborhood.in_(neighborhood)`
   - Validate rent_max >= rent_min if both provided; raise 422 with detail "rent_max must be >= rent_min"
   - Convert results to UnitOut list using a helper `_to_unit_out(unit: Unit) -> UnitOut`:
     - Map unit fields directly
     - building_name from unit.building.name
     - building_url from unit.building.url
     - neighborhood from unit.building.neighborhood
     - last_scraped from unit.building.last_scraped_at
   - Return UnitsResponse(units=[...], total=len(units))
   - No pagination per user decision -- dataset is ~2-5K units total.
   - Flat error messages per user decision: `{"detail": "error message"}`

3. Update `src/moxie/api/main.py`:
   - Import all three routers
   - Add `app.include_router(auth_router)` for /auth/*
   - Add `app.include_router(admin_router)` for /admin/*
   - Add `app.include_router(units_router)` for /units
   - Keep the /health endpoint
  </action>
  <verify>
Run: `export PATH="/c/Users/eimil/.local/bin:$PATH" && cd "C:/Users/eimil/projects/Roxie Projects/moxie-buildings"`

Test schemas:
`uv run python -c "from moxie.api.schemas.units import UnitOut, UnitsResponse; print('unit schemas OK')"`

Test app with all routers mounted:
```python
uv run python -c "
from fastapi.testclient import TestClient
from moxie.api.main import app
c = TestClient(app)
# Health check
r = c.get('/health')
assert r.status_code == 200
# Units without auth should be 403 (HTTPBearer returns 403 for missing token)
r = c.get('/units')
assert r.status_code == 403, f'Expected 403 got {r.status_code}'
# Admin without auth should be 403
r = c.get('/admin/buildings')
assert r.status_code == 403, f'Expected 403 got {r.status_code}'
print('All routes wired, auth enforced')
"
```

Test OpenAPI schema renders:
`uv run python -c "from moxie.api.main import app; schema = app.openapi(); routes = [r for r in schema['paths'].keys()]; print(f'Routes: {routes}'); assert '/units' in routes; assert '/auth/login' in routes; assert '/admin/buildings' in routes; print('OpenAPI OK')"`

Run existing tests: `uv run pytest tests/ -x -q` -- all pass.
  </verify>
  <done>
GET /units endpoint accepts all filter params (beds, rent_min, rent_max, available_before, neighborhood), joins Unit to Building for last_scraped timestamp, filters out non_canonical units, and returns wrapped response with total count. All 3 routers mounted in app. Unauthenticated requests rejected. OpenAPI schema renders all routes.
  </done>
</task>

</tasks>

<verification>
1. `uv run python -c "from moxie.api.main import app; schema = app.openapi(); print(sorted(schema['paths'].keys()))"` -- shows all expected routes
2. Login flow: POST /auth/login with valid admin credentials returns JWT
3. Protected routes: GET /units without token returns 401/403
4. Admin routes: /admin/* without admin role returns 403
5. `uv run pytest tests/ -x -q` -- all existing tests pass
</verification>

<success_criteria>
- POST /auth/login accepts JSON body with email+password, returns JWT
- Invalid credentials return 401 (not 500)
- Inactive users cannot log in
- POST /admin/users creates agent accounts (admin-only, 201)
- PATCH /admin/users/{id}/deactivate disables accounts (admin-only)
- GET /admin/buildings returns all buildings with platform and last_scraped_at
- POST /admin/rescrape/{building_id} returns job_id (202), 409 if already running
- GET /admin/rescrape/{job_id} returns current scrape job status
- GET /units accepts all filter params and returns matching units with last_scraped
- Non-canonical units filtered out by default
- All /admin/* endpoints require admin role (403 for agents)
- All protected endpoints require valid JWT (401/403 for unauthenticated)
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-api-layer/04-02-SUMMARY.md`
</output>
