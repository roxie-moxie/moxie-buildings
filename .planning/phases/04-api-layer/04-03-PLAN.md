---
phase: 04-api-layer
plan: 03
type: execute
wave: 3
depends_on:
  - 04-02
files_modified:
  - tests/api/__init__.py
  - tests/api/conftest.py
  - tests/api/test_auth.py
  - tests/api/test_admin.py
  - tests/api/test_units.py
autonomous: true
requirements:
  - AGENT-01
  - ADMIN-01
  - ADMIN-02
  - ADMIN-03
  - ADMIN-04

must_haves:
  truths:
    - "Test suite proves an agent can log in and access protected endpoints"
    - "Test suite proves admin can create and deactivate agent accounts"
    - "Test suite proves a deactivated user's JWT is rejected"
    - "Test suite proves building list returns real building data"
    - "Test suite proves re-scrape trigger returns job_id and rejects duplicates"
    - "Test suite proves unit search filters work correctly (beds, rent range, date, neighborhood)"
    - "Test suite proves non-canonical units are excluded from search results"
    - "Test suite proves unauthenticated requests are rejected"
    - "Test suite proves non-admin users cannot access admin endpoints"
  artifacts:
    - path: "tests/api/conftest.py"
      provides: "Test fixtures: in-memory SQLite, TestClient, auth helpers, seeded data"
      contains: "dependency_overrides"
    - path: "tests/api/test_auth.py"
      provides: "Login endpoint tests"
      min_lines: 40
    - path: "tests/api/test_admin.py"
      provides: "Admin endpoint tests"
      min_lines: 60
    - path: "tests/api/test_units.py"
      provides: "Unit search endpoint tests"
      min_lines: 60
  key_links:
    - from: "tests/api/conftest.py"
      to: "src/moxie/api/main.py"
      via: "TestClient(app) with dependency override"
      pattern: "dependency_overrides.*get_db"
    - from: "tests/api/conftest.py"
      to: "src/moxie/db/models.py"
      via: "Base.metadata.create_all for in-memory test DB"
      pattern: "Base\\.metadata\\.create_all"
---

<objective>
Create a comprehensive integration test suite for all Phase 4 API endpoints using FastAPI TestClient with in-memory SQLite, proving every requirement works end-to-end.

Purpose: Tests provide regression protection and serve as living documentation of the API contract. Each requirement (AGENT-01, ADMIN-01-04) is covered by at least one test that exercises the full request-response cycle.

Output: A test suite in tests/api/ that passes via `uv run pytest tests/api/ -v` and covers all endpoint behaviors.
</objective>

<execution_context>
@C:/Users/eimil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/eimil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-api-layer/04-CONTEXT.md
@.planning/phases/04-api-layer/04-RESEARCH.md
@.planning/phases/04-api-layer/04-01-SUMMARY.md
@.planning/phases/04-api-layer/04-02-SUMMARY.md
@src/moxie/db/models.py
@src/moxie/api/main.py
@src/moxie/api/deps.py
@src/moxie/api/auth.py
@src/moxie/api/routers/auth.py
@src/moxie/api/routers/admin.py
@src/moxie/api/routers/units.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test conftest + auth and admin endpoint tests</name>
  <files>
    tests/api/__init__.py
    tests/api/conftest.py
    tests/api/test_auth.py
    tests/api/test_admin.py
  </files>
  <action>
1. Create `tests/api/__init__.py` (empty).

2. Create `tests/api/conftest.py`:
   - Follow Pattern 8 from 04-RESEARCH.md (FastAPI Testing with DB Override)
   - In-memory SQLite with `StaticPool` (same pattern as existing scraper tests)
   - `create_engine("sqlite://", connect_args={"check_same_thread": False}, poolclass=StaticPool)`
   - `TestingSession = sessionmaker(bind=engine)`
   - Override `get_db` via `app.dependency_overrides[get_db]`
   - `Base.metadata.create_all(engine)` in fixture setup, `Base.metadata.drop_all(engine)` in teardown
   - Fixture: `client` -- yields TestClient(app), with clean DB per test
   - Fixture: `db_session` -- yields a TestingSession for direct DB manipulation in tests
   - Helper: `create_test_user(db, email, password, role="agent", is_active=True)` -- creates a User with hashed password, returns the User object
   - Helper: `get_auth_header(client, email, password)` -- logs in via POST /auth/login and returns `{"Authorization": f"Bearer {token}"}` dict
   - Fixture: `admin_user` -- creates an admin user (admin@test.com / adminpass123)
   - Fixture: `admin_headers` -- returns auth headers for the admin user
   - Fixture: `agent_user` -- creates an agent user (agent@test.com / agentpass123)
   - Fixture: `agent_headers` -- returns auth headers for the agent user

3. Create `tests/api/test_auth.py`:
   Test class `TestLogin`:
   - `test_login_valid_credentials` -- POST /auth/login with admin credentials returns 200, response has access_token and token_type="bearer"
   - `test_login_invalid_email` -- POST /auth/login with unknown email returns 401
   - `test_login_invalid_password` -- POST /auth/login with wrong password returns 401
   - `test_login_inactive_account` -- Create inactive user, try login, expect 401 "Account is inactive"
   - `test_login_returns_working_jwt` -- Login, use returned token to GET /units (or /health), expect 200 (not 401)

   Test class `TestAuthProtection`:
   - `test_no_token_returns_403` -- GET /units without Authorization header returns 403 (HTTPBearer behavior)
   - `test_invalid_token_returns_401` -- GET /units with Authorization: Bearer garbage returns 401
   - `test_expired_token_returns_401` -- Create a token with exp in the past (import jwt directly, encode with exp=-1h), use it, expect 401
   - `test_deactivated_user_token_rejected` -- Login as agent, deactivate agent via DB, make request with same token, expect 401

4. Create `tests/api/test_admin.py`:
   Test class `TestCreateUser` (ADMIN-01):
   - `test_admin_creates_agent` -- POST /admin/users with valid body returns 201, response has role="agent", is_active=True
   - `test_duplicate_email_returns_409` -- Create user, try creating same email again, expect 409
   - `test_short_password_rejected` -- POST /admin/users with password < 8 chars returns 422 (Pydantic validation)
   - `test_agent_cannot_create_user` -- POST /admin/users with agent token returns 403

   Test class `TestDeactivateUser` (ADMIN-02):
   - `test_admin_deactivates_agent` -- PATCH /admin/users/{id}/deactivate returns 200 with is_active=False
   - `test_deactivated_agent_cannot_login` -- Deactivate agent, try login, expect 401
   - `test_deactivated_agent_jwt_rejected` -- Login as agent, get token, admin deactivates agent, agent uses same token for GET /units, expect 401
   - `test_deactivate_nonexistent_user_returns_404` -- PATCH /admin/users/99999/deactivate returns 404
   - `test_agent_cannot_deactivate` -- PATCH with agent token returns 403

   Test class `TestListBuildings` (ADMIN-03):
   - `test_admin_lists_buildings` -- Seed 2 buildings in DB, GET /admin/buildings returns list with 2 items, each has name, url, platform, last_scraped_at
   - `test_agent_cannot_list_buildings` -- GET /admin/buildings with agent token returns 403
   - `test_buildings_ordered_by_name` -- Seed buildings "Zebra" and "Alpha", verify response order is Alpha, Zebra
  </action>
  <verify>
Run: `export PATH="/c/Users/eimil/.local/bin:$PATH" && cd "C:/Users/eimil/projects/Roxie Projects/moxie-buildings" && uv run pytest tests/api/test_auth.py tests/api/test_admin.py -v` -- all tests pass.

Run: `uv run pytest tests/ -x -q` -- all tests pass (including existing tests, no regressions).
  </verify>
  <done>
Test conftest provides clean per-test DB, TestClient, and auth helper fixtures. Auth tests verify login success/failure, token validation, and deactivated user rejection. Admin tests verify user creation, deactivation, duplicate handling, building list, and role-based access control. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit search and re-scrape endpoint tests</name>
  <files>
    tests/api/test_units.py
  </files>
  <action>
1. Create `tests/api/test_units.py`:

   **Helper: `seed_building_with_units(db, building_name, neighborhood, units_data, platform="sightmap")`**
   - Creates a Building with the given name, url=f"https://{building_name.lower().replace(' ', '-')}.com", neighborhood, platform
   - Creates Unit records from units_data list of dicts (each has unit_number, bed_type, rent_cents, availability_date; optional: floor_plan_name, baths, sqft, non_canonical)
   - Sets scrape_run_at to datetime.now(timezone.utc) for each unit
   - Returns the Building object

   Test class `TestUnitSearch` (AGENT-01 search):
   - `test_search_returns_all_units` -- Seed 3 canonical units, GET /units returns all 3 with total=3
   - `test_search_excludes_non_canonical` -- Seed 1 canonical + 1 non_canonical unit, GET /units returns only 1
   - `test_filter_by_bed_type_single` -- Seed Studio + 1BR + 2BR units, GET /units?beds=1BR returns only 1BR units
   - `test_filter_by_bed_type_multi` -- GET /units?beds=1BR&beds=2BR returns 1BR and 2BR but not Studio
   - `test_filter_by_rent_min` -- Seed units at 1500, 2000, 2500 dollars (150000, 200000, 250000 cents), GET /units?rent_min=2000 returns only units >= 200000 cents
   - `test_filter_by_rent_max` -- GET /units?rent_max=2000 returns only units <= 200000 cents
   - `test_filter_by_rent_range` -- GET /units?rent_min=1500&rent_max=2000 returns only units in range
   - `test_filter_by_available_before` -- Seed units with dates "2026-03-01" and "2026-04-01", GET /units?available_before=2026-03-15 returns only the March unit
   - `test_available_now_included_with_date_filter` -- Seed unit with availability_date="Available Now", GET /units?available_before=2026-03-01 should include it (Available Now means available immediately)
   - `test_filter_by_neighborhood_single` -- Seed units in "River North" and "Loop", GET /units?neighborhood=River+North returns only River North
   - `test_filter_by_neighborhood_multi` -- GET /units?neighborhood=River+North&neighborhood=Loop returns both
   - `test_combined_filters` -- Apply beds + rent_min + neighborhood together, verify intersection
   - `test_no_filters_returns_all` -- GET /units with no params returns all canonical units
   - `test_response_includes_building_fields` -- Verify each UnitOut has building_name, building_url, neighborhood, last_scraped (from joined Building)
   - `test_unauthenticated_returns_403` -- GET /units without token returns 403

   Test class `TestRescrape` (ADMIN-04):
   - `test_trigger_rescrape_returns_202` -- POST /admin/rescrape/{building_id} with admin token returns 202 with job_id and status="queued"
   - `test_rescrape_nonexistent_building_returns_404` -- POST /admin/rescrape/99999 returns 404
   - `test_rescrape_duplicate_returns_409` -- Trigger re-scrape, immediately trigger again for same building, expect 409. Note: for this test, mock `asyncio.to_thread` to block (or use a slow mock) so the first job is still "running" when the second request arrives. Alternatively, directly insert into `_building_jobs` dict to simulate an active job.
   - `test_poll_rescrape_returns_status` -- Trigger re-scrape, GET /admin/rescrape/{job_id}, expect valid status object
   - `test_poll_unknown_job_returns_404` -- GET /admin/rescrape/nonexistent-uuid returns 404
   - `test_agent_cannot_trigger_rescrape` -- POST /admin/rescrape/{building_id} with agent token returns 403

   **Important implementation notes:**
   - For re-scrape tests, mock `scrape_one_building` to avoid actual scraping. Patch `moxie.api.routers.admin.scrape_one_building` (the imported name in the admin router module).
   - Use `unittest.mock.patch` or `monkeypatch` for the mock.
   - The mock should return `{"status": "success", "unit_count": 5, "error": None}`.
   - For the 409 test, directly manipulate the `_building_jobs` dict from `moxie.api.routers.admin` to simulate an active job, since async tasks complete too fast in tests.
  </action>
  <verify>
Run: `export PATH="/c/Users/eimil/.local/bin:$PATH" && cd "C:/Users/eimil/projects/Roxie Projects/moxie-buildings" && uv run pytest tests/api/test_units.py -v` -- all tests pass.

Run full suite: `uv run pytest tests/ -v` -- all tests pass (no regressions).

Print test count: `uv run pytest tests/api/ --collect-only -q | tail -1` -- should show 30+ tests collected.
  </verify>
  <done>
Unit search tests verify all filter combinations (beds, rent range, available_before, neighborhood), non-canonical exclusion, combined filters, response shape with building fields and last_scraped. Re-scrape tests verify trigger/poll lifecycle, 409 on duplicate, 404 on nonexistent, and admin-only access. Full test suite passes with no regressions.
  </done>
</task>

</tasks>

<verification>
1. `uv run pytest tests/api/ -v` -- all API tests pass
2. `uv run pytest tests/ -v` -- all tests pass (API + existing)
3. Test count: 30+ tests across 3 test files
4. Every requirement has at least one test exercising the full HTTP request-response cycle
</verification>

<success_criteria>
- tests/api/conftest.py provides clean per-test DB isolation via dependency override
- Auth tests prove login works, invalid credentials fail, expired/revoked tokens rejected
- Admin tests prove user CRUD, building list, and role enforcement
- Unit search tests prove all filter params work correctly individually and combined
- Re-scrape tests prove trigger/poll lifecycle with mock scraper
- Non-canonical units excluded from search results
- All tests pass via `uv run pytest tests/ -v` with zero failures
- No regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/04-api-layer/04-03-SUMMARY.md`
</output>
