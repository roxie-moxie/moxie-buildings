---
phase: 02-scrapers
plan: 03
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/moxie/sync/sheets.py
  - tests/test_sheets_sync.py
autonomous: true
requirements: [SCRAP-01, SCRAP-02, SCRAP-03, SCRAP-04, SCRAP-05, SCRAP-06, SCRAP-07, SCRAP-08, SCRAP-09]

must_haves:
  truths:
    - "After sheets_sync(), buildings with recognized URLs have platform set to the detected value (e.g. 'rentcafe', 'ppm')"
    - "Buildings with unrecognized URLs get platform='llm' (catch-all)"
    - "Buildings whose platform is already set (non-null) are not overwritten by detection"
    - "Detection runs on every sync pass, so newly added buildings without a platform get classified"
  artifacts:
    - path: "src/moxie/sync/sheets.py"
      provides: "sheets_sync() extended with platform detection after upsert"
      contains: "detect_platform"
    - path: "tests/test_sheets_sync.py"
      provides: "New tests covering platform detection integration in sync"
      contains: "platform"
  key_links:
    - from: "src/moxie/sync/sheets.py"
      to: "src/moxie/scrapers/platform_detect.py"
      via: "detect_platform() called after building upsert"
      pattern: "from moxie\\.scrapers\\.platform_detect import detect_platform"
---

<objective>
Extend sheets_sync() to integrate platform detection: after upserting each building, if platform is null or empty, call detect_platform(url) and assign the result (or 'llm' if None). Add tests for the new behavior.

Purpose: Per the locked decision, platform detection runs as part of every sheets-sync pass. The Google Sheet has no Platform column, so all buildings start with platform=None. Detection fills them automatically so Phase 2 scrapers can query buildings by platform.

Output: sheets.py updated with detect_platform() integration, test_sheets_sync.py extended with 3-5 new platform tests.
</objective>

<execution_context>
@C:/Users/eimil/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/eimil/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-scrapers/02-01-SUMMARY.md
@src/moxie/sync/sheets.py
@src/moxie/scrapers/platform_detect.py
@tests/test_sheets_sync.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend sheets_sync() with platform detection and add tests</name>
  <files>
    src/moxie/sync/sheets.py
    tests/test_sheets_sync.py
  </files>
  <action>
    IMPORTANT: The locked decision states "Detection fills blanks only — auto-detection only runs when platform is null/empty after sheets-sync. Sheets-sourced values are never overwritten by detection." If a Platform column is later added to the sheet, sheets-sync would write it first and detection would skip that building. For now (no Platform column in sheet), all buildings arrive with platform=None so detection fills all of them.

    1. In src/moxie/sync/sheets.py, add import at the top:
       ```python
       from moxie.scrapers.platform_detect import detect_platform
       ```

    2. After the upsert loop (step 7 in the existing code), add a platform detection pass. This runs on ALL buildings in the DB whose platform is None, not just the ones just upserted. That way existing buildings from a previous sync also get classified if they were missing platform:

       After the existing upsert loop and before the deletion step, add:
       ```python
       # Platform detection: classify any building without a platform value
       for building in db.query(Building).filter(Building.platform.is_(None)).all():
           detected = detect_platform(building.url or "")
           building.platform = detected if detected is not None else "llm"
       ```

    3. In tests/test_sheets_sync.py, add a new test class TestPlatformDetection:
       ```python
       class TestPlatformDetection:
           def test_rentcafe_url_gets_platform_rentcafe(self, ...):
               # Sync a building with a rentcafe.com URL → platform=='rentcafe'

           def test_unrecognized_url_gets_platform_llm(self, ...):
               # Sync a building with a custom URL → platform=='llm'

           def test_existing_platform_not_overwritten(self, ...):
               # Pre-insert a building with platform='ppm', sync same URL → platform remains 'ppm'

           def test_newly_synced_building_gets_platform(self, ...):
               # New building added by sync → platform set immediately
       ```

       Use the same fixture pattern as existing tests: mock gspread, in-memory SQLite, assert Building.platform after calling sheets_sync(db).

       For the "existing platform not overwritten" test: insert a Building with platform='ppm' and the same URL before calling sheets_sync(). After sync, assert building.platform == 'ppm' (not 'llm' or anything else).
  </action>
  <verify>
    - uv run pytest tests/test_sheets_sync.py -v (all existing 29 tests + new platform tests pass)
    - uv run pytest tests/ -v (full suite passes)
    - Manually verify: after uv run sheets-sync (with real creds), query: sqlite3 moxie.db "SELECT name, platform, url FROM buildings LIMIT 20;" — rentcafe.com URLs should show platform='rentcafe', others 'llm'
  </verify>
  <done>sheets_sync() assigns platform to all buildings without one. Existing platform values are preserved. New tests cover detection, preservation, and llm fallback.</done>
</task>

</tasks>

<verification>
- uv run pytest tests/test_sheets_sync.py -v (all tests green including new platform tests)
- uv run pytest tests/ -v (zero failures)
- sheets_sync() docstring updated to mention platform detection behavior
</verification>

<success_criteria>
- Platform detection integrated into sheets_sync() with correct "fills blanks only" behavior
- rentcafe.com URLs → 'rentcafe', ppmapartments.com → 'ppm', etc.
- Unrecognized URLs → 'llm' (not None)
- Existing non-null platform values not overwritten
- Test suite passes (29 original + new platform tests)
</success_criteria>

<output>
After completion, create `.planning/phases/02-scrapers/02-03-SUMMARY.md`
</output>
