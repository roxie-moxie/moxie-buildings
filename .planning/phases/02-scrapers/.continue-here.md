---
phase: 02-scrapers
task: gap-closure
status: in_progress
last_updated: 2026-02-19T18:38:05.104Z
---

<current_state>
rentcafe-creds script complete with three subcommands: extract-codes, extract-tokens,
set-token, status. Root cause of 0/236 original failure fully diagnosed. Token
extraction via marketingapi.rentcafe.com confirmed working for Reside (34 buildings).
Most other companies use RentCafe's Essence full-platform (server-side rendered) —
token never hits browser, manual DevTools sessions required.
</current_state>

<completed_work>

### This session (2026-02-19)

- Built `scripts/detect_platforms.py` (from previous session, already committed)
- Rewrote `extract_rentcafe_credentials.py` as `rentcafe-creds` with subcommands:
  - `extract-codes`: httpx + Playwright DOM fallback to find securecafe.com subdomain
  - `extract-tokens`: Playwright headed-mode network interception
  - `set-token --company X --token Y`: apply manually-captured token to all buildings
  - `status`: per-company coverage table (Code / Token / Ready columns)
- Added `rentcafe-creds` entry point to pyproject.toml
- Ran `extract-codes --building "Fisher Building"` → confirmed VoyagerPropertyCode = "fisherbuildingchicago"
- Diagnosed the apiToken problem exhaustively:
  - signal 1: `api.rentcafe.com/rentcafeapi.aspx?apiToken=` → MISSES (server-side for Essence-platform buildings)
  - signal 2: `marketingapi.rentcafe.com/getdnidetails?PropertyAPIKey=` → WORKS for Reside and buildings using RentCafe tracking script
- Confirmed Reside token extracts automatically via marketing API (dry-run OK)
- Sampled Willow Bridge, Horizon, Waterton, Draper & Kramer, Golub → all MISS (Essence platform)
- Fixed image/CDN URL scoring bug in `_score_link`
- Added `--debug` flag showing all rentcafe-related requests per page
- Added `_build_search_url` to construct securecafe.com apartment search URL from property slug

### Previous sessions
- `scrape` CLI command — spot-check any building
- LLM scraper two-pass crawl + strengthened prompt/filter
- `sheets_sync` Platform column support + `needs_classification` sentinel
- `export-platforms` command
- RentCafe scraper real API implementation (replaced stub)
- sheets-sync run on real ~400 buildings
- All 9 scraper plan tests passing

</completed_work>

<remaining_work>

### RentCafe credential extraction (immediate)
1. Run `extract-codes` on all 237 RentCafe buildings → populate VoyagerPropertyCode in DB
2. Run `extract-tokens --company "Reside"` → auto-extract all 34 Reside tokens
3. For remaining ~11 management companies: manual DevTools sessions per company:
   - Navigate to any building's floor plans page in Chrome
   - DevTools → Network → filter "marketingapi" OR "rentcafeapi"
   - Copy PropertyAPIKey (or apiToken) from request URL
   - Run: `set-token --company "Willow Bridge" --token "VALUE"`
   - Priority order: Willow Bridge (24), Horizon (16), Bozzuto (12), Peak Properties (11)...
   - Note: 3 name deduplication pairs exist (Willow Bridge/Willowbridge, RMK/RMK Managment, Cagan/Cagan Mgmt)

### Stored Reside token note
- Current stored token has `%3d` URL encoding (user copied raw from browser URL)
- New extract-tokens stores URL-decoded form (literal `=`)
- The scraper may need to handle both forms — worth checking if Reside scraper works

### Validation gaps (from Phase 2 verification report, score 3/5)
- SC5: Post-scrape bed type audit (`SELECT COUNT(*) FROM units WHERE non_canonical = 1`)
- Tier 2 CSS selectors (Funnel, AppFolio, Bozzuto, RealPage, Groupfox) — not validated live
- LLM scraper needs re-validation after link-following fix (Fisher Building, AMLI 808)

</remaining_work>

<decisions_made>

- [2026-02-19] Marketing API is the token source: `marketingapi.rentcafe.com/getdnidetails?PropertyAPIKey=TOKEN`
  fires on page load. Token is base64-encoded compound key (C00000PROPID#PROPID#UUID).
  Only works for buildings using RentCafe's tracking/marketing script (not Essence platform).

- [2026-02-19] apiToken confirmed server-side for Essence platform: 0/5 sampled companies
  (Willow Bridge, Horizon, Waterton, Draper & Kramer, Golub) expose the token client-side.
  Fisher Building (Golub) = 174 CDN requests on homepage + floor plans, no api.rentcafe.com.

- [2026-02-19] extract-tokens defaults to headed mode (visible browser) to bypass Cloudflare.
  Headless returns 0 results due to bot detection on floor plans pages.

- [2026-02-19] VoyagerPropertyCode extracted from securecafe.com subdomain in page HTML
  (not from network interception). Fisher Building = "fisherbuildingchicago" confirmed.

- [2026-02-19] Manual DevTools filter: look for "marketingapi" OR "rentcafeapi" in Network tab.
  The PropertyAPIKey value (URL-decoded) is the apiToken to pass to set-token.

</decisions_made>

<blockers>

- **~10-13 management companies** still need manual DevTools token capture. These use
  RentCafe's Essence platform (server-side rendered). Token is NOT visible in browser
  network requests via any automated approach. One DevTools session per company.
  Priority: Willow Bridge (24 bldgs), Horizon (16), Bozzuto (12), Peak Properties (11).

- **Stored Reside token encoding**: Token in DB has `%3d` (URL-encoded `=`). New
  extract-tokens stores decoded form. May cause double-encoding in httpx params.
  Test with `uv run scrape --building "5425 N Clark"` before running full batch.

</blockers>

<context>
The apiToken mystery is now fully solved. The token is exposed in two ways:
1. Marketing API (marketingapi.rentcafe.com): fires on page load, works for ~Reside + some others
2. Availability API (api.rentcafe.com/rentcafeapi.aspx): server-side for Essence-platform buildings

For Essence-platform buildings, the token is effectively a per-management-company
server credential that never touches the browser. DevTools manual capture is the only
path — but it's 10-15 sessions for 80% coverage, which is totally doable.

The extract-codes pass (VoyagerPropertyCode) can be run fully automatically on all
237 buildings. The tokens are the remaining manual work.

After credentials are done: validate Tier 2 CSS scrapers, bed type audit, Phase 3.
</context>

<next_action>
1. Run `uv run rentcafe-creds extract-codes` on all 237 buildings to populate VoyagerPropertyCode
2. Run `uv run rentcafe-creds extract-tokens --company "Reside"` to auto-get Reside tokens
3. Open Chrome DevTools on a Willow Bridge building floor plans page → copy PropertyAPIKey
4. Run `uv run rentcafe-creds set-token --company "Willow Bridge" --token "VALUE"`
5. Repeat for Horizon, Bozzuto, Peak Properties, Waterton, etc.
6. Run `uv run rentcafe-creds status` to track coverage progress
</next_action>
